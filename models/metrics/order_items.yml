semantic_models:
  - name: order_items
    defaults:
      agg_time_dimension: ordered_at
    description: |
      Order items table. This table is at the order-item grain.
    model: ref('order_items')
    
    entities:
      - name: order_item_id
        type: primary
      - name: order_id
        type: foreign
      - name: product_id
        type: foreign

    dimensions:
      - name: ordered_at
        expr: date_trunc('day', ordered_at)
        type: time
        type_params:
          time_granularity: day
      - name: product_name
        type: categorical
      - name: product_type
        type: categorical
      - name: product_description
        type: categorical
      - name: is_food_and_drink
        type: categorical
      - name: is_lifestyle_and_goods
        type: categorical

    measures:
      - name: order_item_count
        expr: order_item_id
        agg: count_distinct
      - name: revenue
        expr: product_price
        agg: sum
      - name: average_revenue
        expr: product_price
        agg: average
      - name: median_revenue
        expr: product_price
        agg: median
      - name: supply_cost
        expr: supply_cost
        agg: sum

metrics:

  #SIMPLE
  - name: revenue
    description: "Sum of the product revenue for each order item. Excludes tax."
    type: simple
    label: "Revenue"
    type_params:
      measure: revenue
  
  - name: avg_revenue
    description: "Average product revenue for each order item. Excludes tax."
    type: simple
    label: "Average Revenue"
    type_params:
      measure: average_revenue

  - name: median_revenue
    description: "Median product revenue for each order item. Excludes tax."
    type: simple
    label: "Median Revenue"
    type_params:
      measure: median_revenue

  - name: supply_cost
    description: "Total supply cost from order items"
    type: simple
    label: "Supply Cost"
    type_params:
      measure: supply_cost

  - name: count_of_order_items
    description: "Number of order items"
    type: simple
    label: "Count of Order Items"
    type_params:
      measure: order_item_count

  #CUMULATIVE
  - name: cumulative_month_revenue
    description: Trailing 1-month cumulative order total
    label: Cumulative 1 Month Revenue
    type: cumulative
    type_params:
      measure:
        name: revenue
        join_to_timespine: true
        fill_nulls_with: 0
      cumulative_type_params:
        window: 1 month
        period_agg: last

  - name: cumulative_revenue_mtd
    label: Cumulative Revenue (MTD)
    description: The month-to-date value of all orders
    type: cumulative
    time_granularity: month
    type_params:
      measure:
        name: revenue
        join_to_timespine: true
        fill_nulls_with: 0
      cumulative_type_params:
        grain_to_date: month
        period_agg: last

  - name: cumulative_supply_cost_mtd
    label: Cumulative Supply Cost (MTD)
    description: The month-to-date supply cost of all orders
    type: cumulative
    time_granularity: month
    type_params:
      measure:
        name: supply_cost
        join_to_timespine: true
        fill_nulls_with: 0
      cumulative_type_params:
        grain_to_date: month
        period_agg: last

  #DERIVED
  - name: gross_profit
    description: "Gross profit of Products"
    type: derived
    label: "Gross Profit"
    type_params:
      expr: revenue - cost
      metrics:
        - name: revenue
        - name: supply_cost
          alias: cost

  - name: cumulative_gross_profit_mtd
    label: Cumulative Gross Profit (MTD)
    description: The month-to-date gross profit of all orders
    type: derived
    type_params:
      expr: revenue - cost
      metrics:
        - name: cumulative_revenue_mtd
          alias: revenue
        - name: cumulative_supply_cost_mtd
          alias: cost
